---
# yaml-language-server: $schema=https://raw.githubusercontent.com/apache/airflow/main/chart/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app airflow
  namespace: *app
spec:
  chart:
    spec:
      chart: airflow
      version: 1.14.0
      sourceRef:
        kind: HelmRepository
        name: *app
        namespace: flux-system
  interval: 30m
  releaseName: *app
  targetNamespace: *app
  values:
    images:
      airflow:
        repository: apache/airflow
        tag: 2.9.2

    executor: "KubernetesExecutor"

    ingress:
      web:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: "nginx"
          kubernetes.io/tls-acme: "true"
          nginx.ingress.kubernetes.io/ssl-redirect: "true"
          cert-manager.io/cluster-issuer: "letsencrypt"
          nginx.ingress.kubernetes.io/auth-url: "https://oauth2.tmem.de/oauth2/auth"
          nginx.ingress.kubernetes.io/auth-signin: "https://oauth2.tmem.de/oauth2/start?rd=https%3A%2F%2F$host$request_uri"
        host: airflow.tmem.de
        tls:
          enabled: true
          secretName: airflow-tls

    workers:
      persistence:
        enabled: false
    triggerer:
      persistence:
        enabled: false
    redis:
      persistence:
        enabled: false

    postgresql:
      primary:
        persistence:
          enabled: false
      readReplicas:
        persistence:
          enabled: false

    dags:
      gitSync:
        enabled: true
        repo: https://github.com/tobimichael96/dags
        branch: main
        rev: HEAD
        subPath: ""
        sshKeySecret: airflow-git

    extraEnvFrom:
      - secretRef:
        name: airflow