---
# yaml-language-server: $schema=https://raw.githubusercontent.com/apache/airflow/main/chart/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app airflow
  namespace: *app
spec:
  chart:
    spec:
      chart: airflow
      version: 1.13.1
      sourceRef:
        kind: HelmRepository
        name: *app
        namespace: flux-system
  interval: 30m
  releaseName: *app
  targetNamespace: *app
  values:
    airflow:
      connections:
        - id: aws_conn
          type: aws
          description: minio connection
          login: ${S3_ACCESS_KEY_ID}
          password: ${S3_ACCESS_KEY_SECRET}
          extra: |
            {
              "endpoint_url": "http://minio.minio:9000"
            }
      connectionsTemplates:
        ACCESS_KEY_ID:
          kind: secret
          name: airflow
          key: S3_ACCESS_KEY_ID
        SECRET_ACCESS_KEY:
          kind: secret
          name: airflow
          key: S3_ACCESS_KEY_SECRET
    config:
      logging:
        remote_logging: 'True'
        logging_level: 'INFO'
        remote_base_log_folder: 's3://airflow-logs'
        remote_log_conn_id: 'aws_conn'
        delete_worker_pods: 'False'
        encrypt_s3_logs: 'False'
      webserver:
        rbac: 'False'
        authenticate: 'False'

    images:
      airflow:
        repository: apache/airflow
        tag: 2.9.2

    executor: "KubernetesExecutor"

    ingress:
      web:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: "nginx"
          kubernetes.io/tls-acme: "true"
          nginx.ingress.kubernetes.io/ssl-redirect: "true"
          cert-manager.io/cluster-issuer: "letsencrypt"
          nginx.ingress.kubernetes.io/auth-url: "https://oauth2.tmem.de/oauth2/auth"
          nginx.ingress.kubernetes.io/auth-signin: "https://oauth2.tmem.de/oauth2/start?rd=https%3A%2F%2F$host$request_uri"
        host: airflow.tmem.de
        tls:
          enabled: true
          secretName: airflow-tls

    createUserJob:
      useHelmHooks: false
      applyCustomEnv: false
    migrateDatabaseJob:
      useHelmHooks: false
      applyCustomEnv: false

    workers:
      persistence:
        enabled: false
    triggerer:
      persistence:
        enabled: false
    redis:
      persistence:
        enabled: false

    postgresql:
      primary:
        persistence:
          enabled: false
      readReplicas:
        persistence:
          enabled: false

    dags:
      gitSync:
        enabled: true
        repo: git@github.com:tobimichael96/dags.git
        branch: main
        rev: HEAD
        ref: main
        subPath: ""
        sshKeySecret: airflow-git

    extraEnvFrom: |
     - secretRef:
        name: 'airflow'