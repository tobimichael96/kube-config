apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app minecraft
  namespace: *app
spec:
  chart:
    spec:
      chart: *app
      version: 5.1.1
      sourceRef:
        kind: HelmRepository
        name: *app
        namespace: flux-system
  interval: 5m
  releaseName: *app
  targetNamespace: *app
  values:
    # ref: https://hub.docker.com/r/itzg/minecraft-server/
    image:
      repository: itzg/minecraft-server
      tag: latest
      pullPolicy: Always

    ## Configure resource requests and limits
    ## ref: http://kubernetes.io/docs/user-guide/compute-resources/
    resources:
      requests:
        memory: 512Mi
        cpu: 500m
      limits:
        memory: 5108Mi
        cpu: 4500m

    workloadAsStatefulSet: false
    strategyType: Recreate

    podSecurityContext:
      runAsUser: 1000
      runAsGroup: 3000
      runAsNonRoot: true
      fsGroup: 2000
      seccompProfile:
        type: RuntimeDefault

    securityContext:
      capabilities:
        drop:
          - ALL
      readOnlyRootFilesystem: true
      allowPrivilegeEscalation: false

    livenessProbe:
      initialDelaySeconds: 30
    readinessProbe:
      initialDelaySeconds: 30

    extraPodSpec:
      hostNetwork: true

    minecraftServer:
      eula: "TRUE"
      # Server type: VANILLA, FORGE, FABRIC, PAPER, SPIGOT, etc.
      type: "VANILLA"
      # One of: LATEST, SNAPSHOT, or a specific version (ie: "1.21.1")
      version: "LATEST"
      # One of: peaceful, easy, normal, hard
      difficulty: normal
      # One of: creative, survival, adventure, spectator
      gameMode: survival
      # Message of the day
      motd: "TME Server"
      # Max connected players
      maxPlayers: 20
      # Max view distance (in chunks)
      viewDistance: 32
      # World save name
      worldSaveName: world
      # Define this if you want a specific map generation seed
      levelSeed: ""
      # One of: DEFAULT, FLAT, LARGEBIOMES, AMPLIFIED, CUSTOMIZED
      levelType: DEFAULT
      # After a player has idled for this many minutes they get kicked (0 = disabled)
      playerIdleTimeout: 5
      # Check accounts against Minecraft account service
      onlineMode: true
      # Enable PvP
      pvp: true
      # Enable command blocks
      enableCommandBlock: true
      # Whitelist players (comma-separated usernames)
      whitelist: "Ausraster8,DiaEmperador,OneAndOnlyMEK,Hansomili,Yasuo421,EinsEntlein7260,DavisMo1786,Greinox8057,StamiinUp"
      # Ops (comma-separated usernames)
      ops: "Ausraster8"
      # Memory allocation
      memory: 4G
      # JVM options
      jvmOpts: ""
      # Service port (default 25565)
      servicePort: 25565
      # Service type
      serviceType: ClusterIP
      # RCON configuration
      rcon:
        enabled: false
        port: 25575
        password: ""

    persistence:
      storageClass: "local-storage"
      dataDir:
        enabled: true
        existingClaim: minecraft-pvc
        Size: 100Gi
        accessModes:
          - ReadWriteOnce
