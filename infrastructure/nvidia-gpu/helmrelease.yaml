---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nvidia-plugin-gpu
  namespace: kube-system
spec:
  chart:
    spec:
      chart: gpu-operator
      version: v25.3.4
      sourceRef:
        kind: HelmRepository
        name: nvidia
        namespace: flux-system
  interval: 5m
  releaseName: nvidia-plugin-gpu
  targetNamespace: kube-system
  values:
    toolkit:
      env:
        - name: CONTAINERD_CONFIG
          value: "/var/lib/rancher/rke2/agent/etc/containerd/config.toml"
        - name: CONTAINERD_SOCKET
          value: /run/k3s/containerd/containerd.sock
        - name: ACCEPT_NVIDIA_VISIBLE_DEVICES_ENVVAR_WHEN_UNPRIVILEGED
          value: "false"
        - name: ACCEPT_NVIDIA_VISIBLE_DEVICES_AS_VOLUME_MOUNTS
          value: "true"
    driver:
      version: "570.86.16"
    devicePlugin:
      enabled: true
      env:
        - name: PASS_DEVICE_SPECS
          value: "true"
        - name: FAIL_ON_INIT_ERROR
          value: "true"
        - name: DEVICE_LIST_STRATEGY
          value: volume-mounts
        - name: DEVICE_ID_STRATEGY
          value: uuid
        - name: NVIDIA_VISIBLE_DEVICES
          value: all
        - name: NVIDIA_DRIVER_CAPABILITIES
          value: all
      config:
        name: time-slicing-config
        create: true
        default: rtx-3050
        data:
          rtx-3050: |
            version: v1
            sharing:
              timeSlicing:
                resources:
                - name: nvidia.com/gpu
                  replicas: 4

    operator:
      defaultRuntime: containerd